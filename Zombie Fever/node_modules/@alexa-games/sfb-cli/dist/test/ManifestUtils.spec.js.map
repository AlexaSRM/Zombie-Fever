{"version":3,"file":"ManifestUtils.spec.js","sourceRoot":"","sources":["../../test/ManifestUtils.spec.ts"],"names":[],"mappings":"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","sourcesContent":["import { ManifestUtils } from '../lib/manifestUtils';\nimport { ConsoleStdOutput } from '../lib/consoleStdOutput';\nimport { SinonStub, stub } from 'sinon';\n\nimport { strict as assert } from 'assert';\nimport { ConsoleLogger } from '../lib/consoleLogger';\n\nconst TestManifest = {\n    dependencies: {\n        '@alexa-games/sfb-f': 'file:../sfb-f',\n        '@alexa-games/sfb-skill': 'file:../sfb-skill',\n        'norm': '^1.0.0'\n    }\n};\n\ndescribe('ManifestUtils', () => {\n    let getPackageVersionFromNpmStub: SinonStub<[string, any], Promise<string>> | undefined;\n    let readRawPackageVersionStub: SinonStub<[], any>;\n\n    beforeEach(() => {\n        readRawPackageVersionStub = stub(ManifestUtils, 'readRawPackageVersion').callsFake(\n            () => { \n                return '0.5.0-alpha.3' \n            });\n    });\n\n    afterEach(() => {\n        if (getPackageVersionFromNpmStub) {\n            getPackageVersionFromNpmStub.restore();\n            getPackageVersionFromNpmStub = undefined;\n        }\n        readRawPackageVersionStub.restore();\n    });\n\n    it('repairPackageManifest', async () => {\n        const testManifest = JSON.parse(JSON.stringify(TestManifest));\n\n        await ManifestUtils.repairPackageManifest(testManifest);\n\n        assert.equal(testManifest.dependencies['@alexa-games/sfb-f'], '^0.0.0', 'Should match last version.');\n        assert.equal(testManifest.dependencies['@alexa-games/sfb-skill'], '^0.0.0', 'Should match last version.');\n        assert.equal(testManifest.dependencies['norm'], '^1.0.0', 'Should be unchanged.');\n    });\n\n    it('repairPackageManifest ver 1', async () => {\n        readRawPackageVersionStub.restore();\n        readRawPackageVersionStub = stub(ManifestUtils, 'readRawPackageVersion').callsFake(\n            () => { \n                return '1.1.4' \n            });\n\n        const testManifest = JSON.parse(JSON.stringify(TestManifest));\n\n        await ManifestUtils.repairPackageManifest(testManifest);\n\n        assert.equal(testManifest.dependencies['@alexa-games/sfb-f'], '^1.0.0', 'Should match last version.');\n        assert.equal(testManifest.dependencies['@alexa-games/sfb-skill'], '^1.0.0', 'Should match last version.');\n        assert.equal(testManifest.dependencies['norm'], '^1.0.0', 'Should be unchanged.');\n    });\n\n    it('Multiple package versions', async () => {\n        getPackageVersionFromNpmStub = stub(ManifestUtils, 'getPackageVersionsFromNpm').callsFake(async (packageName, stdOutput) => {\n            return \"sfb-f@0.1.0 '0.1.0'\\nsfb-f@0.1.1 '0.1.1'\\nsfb-f@0.2.0 '0.2.0'\\nsfb-f@0.2.1 '0.2.1'\\n\" + \n            \"sfb-f@0.3.0 '0.3.0'\\nsfb-f@0.4.0 '0.4.0'\\nsfb-f@0.5.0 '0.5.0'\\nsfb-f@0.5.1 '0.5.1'\";\n        })\n\n        const version = await ManifestUtils.getLatestsMajorVersionFromNpm(\n            { \n                name: '@alexa-games/any-thing', \n                version: '0.1.0' \n            }, \n            new ConsoleStdOutput());\n\n        assert.equal(version, '0.5.1', 'Should match last version.');\n    });\n\n    it('Single package version', async () => {\n        getPackageVersionFromNpmStub = stub(ManifestUtils, 'getPackageVersionsFromNpm').callsFake(async (packageName, stdOutput) => {\n            return \"0.5.0-test.3\";\n        });\n\n        const version = await ManifestUtils.getLatestsMajorVersionFromNpm(\n            { \n                name: '@alexa-games/any-thing', \n                version: '0.1.0' \n            }, \n            new ConsoleStdOutput());\n\n\n        assert.equal(version, '0.5.0-test.3', 'Should match only version.');\n    });\n\n    it('Story package compatible', async () => {\n\n        // This should be ok since the sfb-f version range is anything higher than 1.1.0 (but less than 2.0.0)\n        ManifestUtils.checkDeploymentPackageVersionWithTooling(\n            {\n                dependencies: {\n                    '@alexa-games/sfb-f': '^1.1.0'\n                }\n            }, \n            {\n                name: '@alexa-games/sfb-cli',\n                version: '1.2.3'\n            },\n            new ConsoleLogger());\n    });\n\n    it('Story package newer', async () => {\n\n        // This should be ok since the sfb-f version range is anything higher than 1.1.0 (but less than 2.0.0)\n        try {\n            ManifestUtils.checkDeploymentPackageVersionWithTooling(\n                {\n                    dependencies: {\n                        '@alexa-games/sfb-f': '^1.3.0'\n                    }\n                }, \n                {\n                    name: '@alexa-games/sfb-cli',\n                    version: '1.2.3'\n                },\n                new ConsoleLogger());\n            assert(false, 'Should have thrown by now.')\n        } catch (e) {\n            assert(e.message && e.message.indexOf('is not compatible') > 0, 'Should report not compatible.');\n        }\n    });\n\n    it('Story wrong major version', async () => {\n\n        // This should be ok since the sfb-f version range is anything higher than 1.1.0 (but less than 2.0.0)\n        try {\n            ManifestUtils.checkDeploymentPackageVersionWithTooling(\n                {\n                    dependencies: {\n                        '@alexa-games/sfb-f': '^2.0.0'\n                    }\n                }, \n                {\n                    name: '@alexa-games/sfb-cli',\n                    version: '1.2.3'\n                },\n                new ConsoleLogger());\n            assert(false, 'Should have thrown by now.')\n        } catch (e) {\n            assert(e.message && e.message.indexOf('is not compatible') > 0, 'Should report not compatible.');\n        }\n    });\n});\n\n"]}